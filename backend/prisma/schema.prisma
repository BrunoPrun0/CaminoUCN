// schema.prisma - ACTUALIZACIÓN

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id            Int         @id @default(autoincrement())
  apiStudentId  String      @unique  // Este sería el RUT
  name          String?
  email         String?
  careerCode    String?     // Código de carrera
  catalogCode   String?     // Catálogo
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  projections   Projection[]

  @@map("students")
}

model Projection {
  id            Int      @id @default(autoincrement())
  studentId     Int
  name          String   // Nombre de la proyección (ej: "Plan A", "Graduación 2026")
  isFavorite    Boolean  @default(false)
  isAutomatic   Boolean  @default(false) // true si es proyección automática
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courses       ProjectionCourse[]

  @@unique([studentId, name]) // No puede haber dos proyecciones con el mismo nombre
  @@map("projections")
}

model ProjectionCourse {
  id            Int      @id @default(autoincrement())
  projectionId  Int
  courseApiId   String   // Código del curso (ej: DCCB-00142)
  semesterNumber Int     // Número de semestre en la proyección (1, 2, 3, ...)
  credits       Int      // Créditos del curso (para cálculos rápidos)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  projection    Projection @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  @@unique([projectionId, courseApiId]) // Un curso no puede estar duplicado en la misma proyección
  @@index([projectionId, semesterNumber]) // Para consultas por semestre
  @@map("projection_courses")
}

// Migración sugerida:
// 1. npx prisma migrate dev --name add_semester_to_projections
// 2. Actualizar registros existentes si los hay